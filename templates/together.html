<!DOCTYPE html>
<html>
<head>
  <title>AIMWM â€“ Personal Therapist</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<header class="header">
  <div class="logos-container">
    <img src="{{ url_for('static', filename='css/truLog.jpg') }}" class="logo">
    <h1>AIMWM â€“ Your Personal Therapist</h1>
  </div>
  <div class="user-container">
    <h3>Welcome</h3>
    <img src="{{ url_for('static', filename='css/userLog.jpg') }}" class="logo">
  </div>
</header>

<main class="content">
  <!-- LEFT: CHAT -->
  <section class="left-section">
    <div id="chatBox"></div>

    <div class="controls">
      <button id="speechBtn">ðŸŽ™ Speak</button>
      <label>
        <input type="checkbox" id="ttsToggle"> ðŸ”Š Read replies
      </label>
    </div>

    <form id="chatForm">
      <input type="text" id="userMessage" placeholder="Type your messageâ€¦" required>
      <button type="submit">Send</button>
    </form>
  </section>

  <!-- RIGHT: CAMERA + SONGS -->
  <section class="right-section">
    <img src="{{ url_for('video') }}" class="video">

    <div class="songs">
      <h3>ðŸŽ¶ Recommended Songs</h3>
      <ul id="songList"></ul>
    </div>
  </section>
</main>

<script>
/* ---------------- CHAT ---------------- */
$('#chatForm').on('submit', function(e) {
  e.preventDefault();
  const msg = $('#userMessage').val();
  $('#userMessage').val('');

  $('#chatBox').append(`<div class="bubble user">${msg}</div>`);

  $.ajax({
    url: "/chat",
    method: "POST",
    contentType: "application/json",
    data: JSON.stringify({ message: msg }),
    success: function(res) {
      // âœ… FIX: correct key
      const reply = res.reply;

      $('#chatBox').append(`<div class="bubble bot">${reply}</div>`);

      if ($('#ttsToggle').is(':checked')) {
        speak(reply);
      }

      // songs (DO NOT TOUCH)
      if (res.songs) {
        $('#songList').empty();
        res.songs.forEach(s => {
          $('#songList').append(`<li>${s}</li>`);
        });
      }
    }
  });
});

/* ---------------- SPEECH TO TEXT ---------------- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = 'en-US';

$('#speechBtn').click(() => recognition.start());

recognition.onresult = e => {
  $('#userMessage').val(e.results[0][0].transcript);
};

/* ---------------- TEXT TO SPEECH ---------------- */
function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(utter);
}
</script>

</body>
</html>
